rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Funções auxiliares para controle de acesso
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'super_admin';
    }
    
    function isEditor() {
      return isAuthenticated() && getUserRole() in ['admin', 'editor', 'super_admin'];
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Função alternativa usando UID direto (mais confiável)
    function isAdminByUID() {
      return isAuthenticated() && request.auth.uid in [
        'yOq2irEaKrdWo5nolbwwr8xnqhw2', // admin@conexaogoias.com
        'yFQeyKsxpvgnjDMB2kjlJqMvifZ2', // herbert@conexaogoias.com
        'zrhO0AuVVxXeErxD883SrpoZGxg1'  // rafael2009121@gmail.com (super_admin)
      ];
    }
    
    // Regras para imagens de capa de notícias
    match /covers/{fileName} {
      // Qualquer um pode ler imagens de capa (público)
      allow read: if true;
      
      // Apenas usuários autenticados podem fazer upload
      allow write: if request.auth != null &&
        request.resource.size < 5 * 1024 * 1024 && // 5MB max
        request.resource.contentType.matches('image/.*');
    }
    
    // Regras para imagens de conteúdo
    match /content/{fileName} {
      // Qualquer um pode ler imagens de conteúdo (público)
      allow read: if true;
      
      // Apenas usuários autenticados podem fazer upload
      allow write: if request.auth != null &&
        request.resource.size < 5 * 1024 * 1024 && // 5MB max
        request.resource.contentType.matches('image/.*');
    }
    
    // Regras para banners
    match /banners/{fileName} {
      // Qualquer um pode ler banners (público)
      allow read: if true;
      
      // Apenas admins podem fazer upload de banners
      allow write: if isAdminByUID() &&
        request.resource.size < 10 * 1024 * 1024 && // 10MB max
        request.resource.contentType.matches('image/.*');
    }
    
    // Regras para biblioteca de mídia
    match /media/{fileName} {
      // Qualquer um pode ler arquivos de mídia (público)
      allow read: if true;
      
      // Apenas editores podem fazer upload de mídia
      allow write: if isEditor() &&
        request.resource.size < 10 * 1024 * 1024 && // 10MB max
        (request.resource.contentType.matches('image/.*') ||
         request.resource.contentType.matches('video/.*') ||
         request.resource.contentType.matches('application/pdf'));
    }
    
    // Regras para imagens de perfil
    match /profiles/{userId}/{fileName} {
      // Usuários podem ler suas próprias imagens
      allow read: if isOwner(userId);
      
      // Usuários podem fazer upload de suas próprias imagens
      allow write: if isOwner(userId) &&
        request.resource.size < 2 * 1024 * 1024 && // 2MB max
        request.resource.contentType.matches('image/.*');
    }
    
    // Regras para arquivos temporários
    match /temp/{userId}/{fileName} {
      // Usuários podem gerenciar seus próprios arquivos temporários
      allow read, write: if isOwner(userId) &&
        request.resource.size < 10 * 1024 * 1024; // 10MB max
    }
    
    // Regras para favicons
    match /favicons/{fileName} {
      // Qualquer um pode ler favicons (público)
      allow read: if true;
      
      // Apenas admins podem fazer upload de favicons
      allow write: if isAdminByUID() &&
        request.resource.size < 1 * 1024 * 1024 && // 1MB max
        request.resource.contentType.matches('image/.*');
    }
    
    // Regras para logos
    match /logos/{fileName} {
      // Qualquer um pode ler logos (público)
      allow read: if true;
      
      // Apenas admins podem fazer upload de logos
      allow write: if isAdminByUID() &&
        request.resource.size < 2 * 1024 * 1024 && // 2MB max
        request.resource.contentType.matches('image/.*');
    }
    
    // Regras para imagens do roadmap
    match /roadmap/{fileName} {
      // Qualquer um pode ler imagens do roadmap (público)
      allow read: if true;
      
      // Apenas editores podem fazer upload de imagens do roadmap
      allow write: if isEditor() &&
        request.resource.size < 5 * 1024 * 1024 && // 5MB max
        request.resource.contentType.matches('image/.*');
    }
    
    // Regra geral para qualquer outro arquivo - PÚBLICO
    match /{allPaths=**} {
      // Qualquer um pode ler qualquer arquivo (público)
      allow read: if true;
      
      // Negar escrita para arquivos não especificados acima
      allow write: if false;
    }
  }
}